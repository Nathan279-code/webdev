{% extends 'base.html' %}

{% block title %}Menu Public{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
{% endblock %}

{% block sidebar %}
<nav class="bg-light border-end d-flex flex-column p-3" style="width: 300px; min-height: 100vh; padding-left: 3rem;">
  <!-- Contenu scrollable -->
  <div style="flex-grow: 1; overflow-y: auto; padding-right: 1rem;">
    <h4>Recherche d'établissement</h4>
    <input
        type="text"
        id="search-input"
        class="form-control"
        placeholder="Rechercher un établissement..."
        autocomplete="off"
    />

    <h5 class="mt-3">Catégories</h5>
    <div id="categories-list" class="d-flex overflow-auto flex-row gap-2 pb-2" style="white-space: nowrap;">
        <button type="button" class="btn btn-sm btn-outline-secondary active" data-category="ALL">Tous</button>
        {% for cat in categories %}
            <button type="button" class="btn btn-sm btn-outline-primary" data-category="{{ cat.nomcat }}">
                {{ cat.nomcat }}
            </button>
        {% endfor %}
    </div>

    <ul class="list-group mt-2" id="results-list" style="max-height: 300px; overflow-y: auto; overflow-x: hidden;"></ul>

    <div class="accordion mt-4" id="accordionDetails" style="display: none;">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingDetails">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetails" aria-expanded="false" aria-controls="collapseDetails">
            Détails de l’établissement
          </button>
        </h2>
        <div id="collapseDetails" class="accordion-collapse collapse" aria-labelledby="headingDetails">
          <div class="accordion-body">
            <h5 id="etab-nom"></h5>
            <p id="etab-adresse"></p>
            <p id="etab-ville"></p>
            <p>Téléphone : <span id="etab-tel"></span></p>
            <p>Site web : <a href="#" target="_blank" id="etab-siteweb"></a></p>
            {% if current_user.is_authenticated %}
            <button class="btn btn-primary w-100 mt-2" id="btn-ajouter-avis">Ajouter un avis</button>
            {% endif %}
            <hr>

            <!-- Moyenne des avis -->
            <div id="etab-moyenne-avis" class="mb-3 fw-bold" style="display:none;"></div>

            <!-- Accordéon pour les avis -->
            <div class="accordion" id="accordionAvis" style="display:none;">
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingAvis">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAvis" aria-expanded="false" aria-controls="collapseAvis">
                    Avis de l'établissement
                  </button>
                </h2>
                <div id="collapseAvis" class="accordion-collapse collapse" aria-labelledby="headingAvis">
                  <div class="accordion-body" id="avis-list">
                    <!-- Avis chargés dynamiquement ici -->
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Zone fixe en bas -->
  <div style="flex-shrink: 0;">
      {% if current_user.is_authenticated %}
        <div class="mb-2 text-center">
          <div class="fw-semibold mb-1">Connecté en tant que :</div>
          {% if current_user.admin %}
            <span class="badge bg-danger fs-6">Admin</span>
          {% else %}
            <span class="badge bg-primary fs-6">Utilisateur</span>
          {% endif %}
        </div>

        {% if current_user.admin %}
          <a href="{{ url_for('main.menu') }}" class="btn btn-warning w-100 mb-2">
            <i class="bi bi-speedometer2"></i> Menu Admin
          </a>
        {% endif %}

        <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger w-100">
          <i class="bi bi-box-arrow-right"></i> Déconnexion
        </a>
      {% else %}
        <div class="d-flex flex-column gap-2">
          <a href="{{ url_for('auth.login') }}" class="btn btn-success w-100">
            <i class="bi bi-box-arrow-in-right"></i> Se connecter
          </a>
          <a href="{{ url_for('auth.register') }}" class="btn btn-primary w-100">
            <i class="bi bi-person-plus"></i> S'inscrire
          </a>
        </div>
      {% endif %}
  </div>
</nav>
{% endblock %}

{% block content %}
<main class="flex-grow-1 p-0" style="height: 100vh; overflow: hidden;">
    {% include 'public/map.html' %}
</main>
{% endblock %}

{% block extra_scripts %}
<script>
    function formatDate(dateString) {
        const d = new Date(dateString);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0'); // Les mois commencent à 0
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
    }

    const searchInput = document.getElementById('search-input');
    const resultsList = document.getElementById('results-list');
    const etabDetails = document.getElementById('accordionDetails');
    const etabNom = document.getElementById('etab-nom');
    const etabAdresse = document.getElementById('etab-adresse');
    const etabVille = document.getElementById('etab-ville');
    const etabTel = document.getElementById('etab-tel');
    const etabSiteweb = document.getElementById('etab-siteweb');
    const btnAjouterAvis = document.getElementById('btn-ajouter-avis');

    const etabMoyenneAvis = document.getElementById('etab-moyenne-avis');
    const accordionAvis = document.getElementById('accordionAvis');
    const avisList = document.getElementById('avis-list');

    const categoriesList = document.getElementById('categories-list');
    let selectedEtabId = null;

    // Instance unique du collapse
    let collapseInstance = null;

    function showEtablissementDetails(etab) {
        etabNom.textContent = etab.nom;
        etabAdresse.textContent = `Adresse : ${etab.adresse}`;
        etabVille.textContent = `Ville : ${etab.ville} (${etab.cp})`;
        etabTel.textContent = etab.tel;
        etabSiteweb.textContent = etab.siteweb;
        etabSiteweb.href = etab.siteweb;
        etabDetails.style.display = 'block';

        // Afficher moyenne et avis si disponibles
        fetchAvisEtablissement(etab.id);

        const collapseElement = document.getElementById('collapseDetails');

        if (!collapseInstance) {
            collapseInstance = new bootstrap.Collapse(collapseElement, { toggle: false });
        }

        // Toggle manuellement l'accordéon
        if (collapseElement.classList.contains('show')) {
            collapseInstance.hide();
        } else {
            collapseInstance.show();
        }
    }

    async function showEtablissementDetailsFromId(id) {
      try {
        const res = await fetch(`/etablissement/${id}`);
        if (!res.ok) throw new Error('Établissement non trouvé');
        const etab = await res.json();

        selectedEtabId = etab.id;

        showEtablissementDetails(etab);
        searchInput.value = etab.nom;
        resultsList.innerHTML = '';

        // On ne recrée pas l'instance ici ni ne toggle à nouveau
      } catch (err) {
        alert('Erreur lors du chargement de la fiche.');
        console.error(err);
      }
    }

    async function fetchAvisEtablissement(etabId) {
        try {
            const res = await fetch(`/api/avis/etablissement/${etabId}`);
            if (!res.ok) throw new Error('Erreur lors du chargement des avis.');
            const data = await res.json();

            const avis = data.avis || [];
            const moyenne = data.moyenne;

            if (avis.length > 0) {
                etabMoyenneAvis.style.display = 'block';
                etabMoyenneAvis.textContent = `Moyenne des avis : ${moyenne.toFixed(2)} / 5 (${avis.length} avis)`;

                // Remplir la liste des avis
                avisList.innerHTML = '';
                avis.forEach(a => {
                    const div = document.createElement('div');
                    div.classList.add('mb-3', 'border', 'p-2', 'rounded');
                    div.innerHTML = `
                      <strong>${a.username}</strong> - Note : ${a.note}/5<br>
                      <em>${formatDate(a.datecreation)}</em>
                      <p>${a.commentaire}</p>
                    `;
                    avisList.appendChild(div);
                });

                accordionAvis.style.display = 'block';
            } else {
                etabMoyenneAvis.style.display = 'none';
                accordionAvis.style.display = 'none';
                avisList.innerHTML = '';
            }
        } catch (error) {
            console.error(error);
            etabMoyenneAvis.style.display = 'none';
            accordionAvis.style.display = 'none';
            avisList.innerHTML = '';
        }
    }

    if (btnAjouterAvis) {
      btnAjouterAvis.addEventListener('click', () => {
          if (!selectedEtabId) {
              alert('Veuillez sélectionner un établissement.');
              return;
          }
          window.location.href = `/avis/ajouter?idetab=${selectedEtabId}`;
      });
    }

    searchInput.addEventListener('input', async () => {
        const query = searchInput.value.trim();
        resultsList.innerHTML = '';
        etabDetails.style.display = 'none';
        selectedEtabId = null;

        if (query.length < 2) return;

        const response = await fetch(`/api/etablissements/search?q=${encodeURIComponent(query)}`);
        const etablissements = await response.json();

        if (etablissements.length === 0) {
            resultsList.innerHTML = '<li class="list-group-item">Aucun établissement trouvé.</li>';
            return;
        }

        etablissements.forEach(etab => {
            const li = document.createElement('li');
            li.classList.add('list-group-item', 'list-group-item-action');
            li.textContent = etab.nom;
            li.style.cursor = 'pointer';
            li.addEventListener('click', () => showEtablissementDetailsFromId(etab.id));
            resultsList.appendChild(li);
        });
    });

    // Gestion du filtrage par catégories (multi-sélection)
    let selectedCategories = new Set(['ALL']); // par défaut "Tous"

    categoriesList.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', async () => {
            const category = btn.getAttribute('data-category');

            if (category === 'ALL') {
                // "Tous" sélectionné : désélectionner tout sauf "ALL"
                selectedCategories.clear();
                selectedCategories.add('ALL');
                categoriesList.querySelectorAll('button').forEach(b => {
                    b.classList.toggle('active', b.getAttribute('data-category') === 'ALL');
                });
            } else {
                // Retirer "ALL" si on sélectionne une catégorie spécifique
                selectedCategories.delete('ALL');

                if (selectedCategories.has(category)) {
                    // Désélectionner catégorie
                    selectedCategories.delete(category);
                    btn.classList.remove('active');
                } else {
                    // Sélectionner catégorie
                    selectedCategories.add(category);
                    btn.classList.add('active');
                }

                // Si aucune catégorie sélectionnée, remettre "ALL"
                if (selectedCategories.size === 0) {
                    selectedCategories.add('ALL');
                    categoriesList.querySelector('button[data-category="ALL"]').classList.add('active');
                } else {
                    categoriesList.querySelector('button[data-category="ALL"]').classList.remove('active');
                }
            }

            // Filtrer établissements par catégorie
            resultsList.innerHTML = '';
            etabDetails.style.display = 'none';
            selectedEtabId = null;

            // Construire URL pour la requête API
            let url = '/api/etablissements';
            if (!selectedCategories.has('ALL')) {
                const params = new URLSearchParams();
                selectedCategories.forEach(cat => params.append('categories', cat));
                url += `?${params.toString()}`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Erreur lors du chargement des établissements.');
                const etablissements = await response.json();

                if (etablissements.length === 0) {
                    resultsList.innerHTML = '<li class="list-group-item">Aucun établissement trouvé.</li>';
                    return;
                }

                etablissements.forEach(etab => {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item', 'list-group-item-action');
                    li.textContent = etab.nom;
                    li.style.cursor = 'pointer';
                    li.addEventListener('click', () => showEtablissementDetailsFromId(etab.id));
                    resultsList.appendChild(li);
                });
            } catch (error) {
                console.error(error);
                resultsList.innerHTML = '<li class="list-group-item text-danger">Erreur lors du chargement.</li>';
            }
        });
    });

</script>
{% endblock %}
